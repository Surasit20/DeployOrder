import{ThumbDragStartedEvent as e,ThumbDragDeltaEvent as t,ThumbDragCompletedEvent as s}from"./thumb-1c09cc55.js";import{D as i}from"./dx-scroll-viewer-11139ffa.js";import{C as r}from"./custom-events-helper-18f7786a.js";const n="dxbl-virtual-scroll-viewer",o="data-virtual-item-index",a="dxbl-top-virtual-spacer-element",h="dxbl-bottom-virtual-spacer-element";class c extends CustomEvent{constructor(e){super(c.eventName,{detail:new l(e),bubbles:!0,composed:!0,cancelable:!0})}}c.eventName="dxbl-virtual-scroll-viewer.scroll";class l{constructor(e){this.Position=e}}class u extends CustomEvent{constructor(e){super(u.eventName,{detail:e,bubbles:!0,composed:!0,cancelable:!0})}}u.eventName="dxbl-virtual-scroll-viewer.scrollparamschanged";class m{constructor(e,t,s){this.AverageHeight=e,this.Heights=t,this.ViewportHeight=s}equals(e){return!!e&&(e.AverageHeight===this.AverageHeight&&(e.ViewportHeight===this.ViewportHeight&&!!this.sequenceEquals(e.Heights,this.Heights)))}sequenceEquals(e,t){if(!e)return!1;if(!t)return!1;if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}}class b extends CustomEvent{constructor(e,t){super(b.eventName,{detail:new v(e,t),bubbles:!0,composed:!0,cancelable:!0})}}b.eventName="dxbl-virtual-scroll-viewer.intersectioncallback";class v{constructor(e,t){this.Position=e,this.SpacerHeight=t}}r.register(c.eventName,(e=>e.detail)),r.register(u.eventName,(e=>e.detail)),r.register(b.eventName,(e=>e.detail));customElements.define(n,class extends i{constructor(){super(),this._rootMargin="0px",this._scrollTop=-1,this._viewportHeight=0,this._isThumbDragging=!1,this._averageItemHeight=-1,this._thumbMoveTimerId=-1,this._scrollParams=null,this.boundOnThumbMoveStarted=this.onThumbMoveStarted.bind(this),this.boundOnThumbMove=this.onThumbMove.bind(this),this.boundOnThumbMoveCompleted=this.onThumbMoveCompleted.bind(this)}initializeComponent(){super.initializeComponent(),this.subscribeScrollBarEvents();const e=this.getContentContainerElement();if(this.itemsContainer=this.getItemsContainerElement(),this.spacerTop=this.getTopSpacer(),this.spacerBottom=this.getBottomSpacer(),e&&this.spacerTop&&this.spacerBottom){this._viewportHeight=e.offsetHeight,this.contentContainerResizeObserver=this.createContentContainerResizeObserver(e),this.dispatchScrollParams();const t={root:e,rootMargin:this._rootMargin};this.spacerIntersectionObserver=new IntersectionObserver(this.intersectionCallback.bind(this),t),this.spacerIntersectionObserver.observe(this.spacerTop),this.spacerIntersectionObserver.observe(this.spacerBottom),this.spacerResizeObserver=new ResizeObserver(this.resizeObserverCallback.bind(this)),this.spacerResizeObserver.observe(this.spacerTop),this.spacerResizeObserver.observe(this.spacerBottom)}}disposeComponent(){var e,t,s;super.disposeComponent(),this.unsubscribeScrollBarEvents(),this.reset(),null===(e=this.spacerIntersectionObserver)||void 0===e||e.disconnect(),null===(t=this.spacerResizeObserver)||void 0===t||t.disconnect(),null===(s=this.contentContainerResizeObserver)||void 0===s||s.disconnect()}get averageHeight(){return this._averageItemHeight}get viewportHeight(){return this._viewportHeight}getItemsContainerElement(){return this.querySelector("[data-virtual-items-container]")}getTopSpacer(){return this.querySelector(`[${a}]`)}getBottomSpacer(){return this.querySelector(`[${h}]`)}queryElementsSizeArray(){const e=new Array;if(this.itemsContainer){let t=0;const s=this.groupElements(this.itemsContainer.children);for(const[i,r]of s){let s=0;for(let e=0;e<r.length;e++)s+=r[e].offsetHeight;e.push(i),e.push(s),t+=s}this._averageItemHeight<0&&s.size>0&&(this._averageItemHeight=t/s.size)}return e}groupElements(e){const t=new Map;let s=[];for(let i=0;i<e.length;i++){const r=e[i],n=r.getAttribute(o);this.skipElement(n)||(n&&(s=[],t.set(parseInt(n),s)),s&&s.push(r))}return t}canDispatchPositionUpdate(){return!this._isThumbDragging}skipElement(e){return!!e&&parseInt(e)<0}clearSelection(){const e=window.getSelection?window.getSelection():document.getSelection();e&&e.empty()}onRefresh(e,t){super.onRefresh(e,t),this._scrollTop!==e&&(this.dispatchScrollEvent(e),this._scrollTop=e,this.clearSelection())}intersectionCallback(e){for(let t=0;t<e.length;t++){const s=e[t];if(s.isIntersecting&&this.canDispatchPositionUpdate()){if(s.target===this.spacerTop){this.dispatchEvent(new b(0,s.intersectionRect.top-s.boundingClientRect.top)),this.clearSelection()}if(s.target===this.spacerBottom){this.dispatchEvent(new b(1,s.boundingClientRect.bottom-s.intersectionRect.bottom)),this.clearSelection()}}}}resizeObserverCallback(e){for(let t=0;t<e.length;t++){const s=e[t].target;s.hasAttribute(a)&&this.reconnectIntersectionObserver(this.spacerTop),s.hasAttribute(h)&&this.reconnectIntersectionObserver(this.spacerBottom)}}reconnectIntersectionObserver(e){e&&this.spacerIntersectionObserver&&(this.spacerIntersectionObserver.unobserve(e),this.spacerIntersectionObserver.observe(e))}createContentContainerResizeObserver(e){const t=new ResizeObserver((e=>{this._viewportHeight=e[0].contentRect.height,this.dispatchScrollParams(),this.dispatchScrollEvent(this._scrollTop)}));return t.observe(e),t}subscribeScrollBarEvents(){const e=this.getVerticalScrollBarElement();e&&this.subscribeThumbEvents(e,this.boundOnThumbMoveStarted,this.boundOnThumbMove,this.boundOnThumbMoveCompleted)}unsubscribeScrollBarEvents(){const e=this.getVerticalScrollBarElement();e&&this.unsubscribeThumbEvents(e,this.boundOnThumbMoveStarted,this.boundOnThumbMove,this.boundOnThumbMoveCompleted)}subscribeThumbEvents(i,r,n,o){i.addEventListener(e.eventName,r),i.addEventListener(t.eventName,n),i.addEventListener(s.eventName,o)}unsubscribeThumbEvents(i,r,n,o){i.removeEventListener(e.eventName,r),i.removeEventListener(t.eventName,n),i.removeEventListener(s.eventName,o)}onThumbMoveStarted(e){this._isThumbDragging=!0}onThumbMove(e){-1!==this._thumbMoveTimerId&&clearTimeout(this._thumbMoveTimerId);this._thumbMoveTimerId=setTimeout((()=>{this.dispatchPositionUpdate()}).bind(this),700),this._isThumbDragging=!0}onThumbMoveCompleted(e){this.dispatchPositionUpdate()}dispatchPositionUpdate(){this._isThumbDragging=!1,clearTimeout(this._thumbMoveTimerId),this._thumbMoveTimerId=-1,this.dispatchScrollEvent(this._scrollTop),this.reconnectIntersectionObserver(this.spacerTop),this.reconnectIntersectionObserver(this.spacerBottom)}dispatchScrollEvent(e){this.canDispatchPositionUpdate()&&this.dispatchEvent(new c(e))}dispatchScrollParams(){const e=new m(this._averageItemHeight,this.queryElementsSizeArray(),this._viewportHeight);e.equals(this._scrollParams)||(this._scrollParams=e,this.dispatchEvent(new u(this._scrollParams)))}onStateChanged(e){e&&this.dispatchScrollParams()}reset(){this._scrollParams=null}static get observedAttributes(){return["reset-v-scroll-guid","reset-h-scroll-guid","request-make-element-visible","state-has-changed"]}attributeChangedCallback(e,t,s){if(super.attributeChangedCallback(e,t,s),"state-has-changed"===e)this.onStateChanged(s)}});export{h as B,n as D,a as T,o as V};
